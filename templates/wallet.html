{% extends "base.html" %}

{% block title %}Wallet{% endblock %}

{% block content %}
<div class="main-panel">
    <div class="main-header">
      <div class="main-header-logo">
        <!-- Logo Header -->
        <div class="logo-header" data-background-color="dark">
          <a href="index.html" class="logo">
            <img
              src="static/img/kaiadmin/logo_light.svg"
              alt="navbar brand"
              class="navbar-brand"
              height="20"
            />
          </a>
          <div class="nav-toggle">
            <button class="btn btn-toggle toggle-sidebar">
              <i class="gg-menu-right"></i>
            </button>
            <button class="btn btn-toggle sidenav-toggler">
              <i class="gg-menu-left"></i>
            </button>
          </div>
          <button class="topbar-toggler more">
            <i class="gg-more-vertical-alt"></i>
          </button>
        </div>
        <!-- End Logo Header -->
      </div>
      <!-- Navbar Header -->
      <nav
        class="navbar navbar-header navbar-header-transparent navbar-expand-lg border-bottom"
      >
        <div class="container-fluid">
          <ul class="navbar-nav topbar-nav ms-md-auto align-items-center">
            <li class="nav-item topbar-user dropdown hidden-caret">
                <span class="profile-username">
                  <span class="op-7">Hi,</span>
                  <span class="fw-bold">{{username}}</span>
                </span>
            </li>
          </ul>
        </div>
      </nav>
      <!-- End Navbar -->
    </div>

    <div class="container">
      <div class="page-inner">
        <div
          class="d-flex align-items-left align-items-md-center flex-column flex-md-row pt-2 pb-4"
        >
          <div>
            <h3 class="fw-bold mb-3">Wallet Page</h3>
            <h6 class="op-7 mb-2">Hi {{username}}, Let's build a better community together. </h6>
          </div>
          <div class="ms-md-auto py-2 py-md-0">
            <a href="#" class="btn btn-label-info btn-round me-2">Leaderboard</a>
            
          </div>
        </div>

        <div class="row">
          <div class="toggle-switch col-md-1">
            <input id="fundWallet" type="radio" name="switch" checked>
            <label for="fundWallet" class="toggle-label">Fund</label>
            <input id="cpWallet" type="radio" name="switch">
            <label for="cpWallet" class="toggle-label">CarePoint</label>
            <div class="toggle-slider"></div>
          </div>
          <div class="col-md-10"></div>
        </div>
        
        <br>
        
        <div class="row">
          <div id="fundWalletSection">
            <div class="row">
              <div class="col-md-6">
                <div class="card card-secondary bg-secondary-gradient" style="min-height: 450px">
                  <div class="card-body skew-shadow">
                    <img
                      src="static/img/visa.svg"
                      height="30"
                      alt="Visa Logo"
                    />
                    <br><br><br><br><br><br><br><br><br><br><br>
                    <h2 class="py-4 mb-0">1234 **** **** 5678</h2>
                    <br>
                    <div class="row">
                      <div class="col-8 pe-0">
                        <h3 class="fw-bold mb-1">{{username}}</h3>
                        <div class="text-small text-uppercase fw-bold op-8">
                          Card Holder
                        </div>
                      </div>
                      <div class="col-4 ps-0 text-end">
                        <h3 class="fw-bold mb-1">4/26</h3>
                        <div class="text-small text-uppercase fw-bold op-8">
                          Expired
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card card-default card-round">
                  <div class="card-header">
                    <div class="card-head-row">
                      <div class="card-title">Fund Wallet</div>
                    </div>
                  </div>
                  <div class="card-body pb-0" style="min-height: 400px">
                    <div class="mb-4 mt-2">
                      <br><br>
                      <!-- Display user balance -->
                      <h1 id="balance">Loading...</h1>
                      <br><br><br><br><br><br><br><br><br>
                      <button type="button" class="btn btn-secondary btn-round" id="topUpButton">
                        Top Up
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-2">
                <div class="card card-stats card-round">
                  <div class="card-body">
                  <a href="">
                    <div class="row align-items-center">
                      <div class="col-icon">
                        <div
                          class="icon-big text-center icon-secondary bubble-shadow-small"
                        >
                          <i class="fas fa-money-check"></i>
                        </div>
                      </div>
                      <div class="col col-stats ms-3 ms-sm-0">
                        <div class="numbers">
                          
                          <h4 class="card-category">Top Up for more charity</h4>
                        </div>
                      </div>
                    </div>
                  </div>
                </a>
                </div>
                
                <div class="card card-stats card-round">
                  <div class="card-body">
                    <a href=""> <!--Add link here-->
                    <div class="row align-items-center">
                      <div class="col-icon">
                        <div
                          class="icon-big text-center icon-info bubble-shadow-small"
                        >
                          <i class="fas fa-history"></i>
                        </div>
                      </div>
                      <div class="col col-stats ms-3 ms-sm-0">
                        <div class="numbers">
                          
                          <h4 class="card-category">View your Fund History here</h4>
                        </div>
                      </div>
                    </div>
                  </a>
                  </div>
                </div>

                <div>
                  <div class="card card-stats card-round">
                    <div class="card-body">
                    <a href=""> <!--Add link here-->
                      <div class="row align-items-center">
                        <div class="col-icon">
                          <div
                            class="icon-big text-center icon-secondary bubble-shadow-small"
                          >
                            <i class="fas fa-star"></i>
                          </div>
                        </div>
                        <div class="col col-stats ms-3 ms-sm-0">
                          <div class="numbers">
                            
                            <h4 class="card-category">Use your Care Point Here</h4>
                          </div>
                        </div>
                      </div>
                    </a>
                    </div>
                  </div>
                </div>
                <div>
                  <div class="card card-stats card-round">
                    <div class="card-body">
                      <a href=""><!--Add link here-->
                      <div class="row align-items-center">
                        <div class="col-icon">
                          <div
                            class="icon-big text-center icon-info bubble-shadow-small"
                          >
                            <i class="far fa-clock"></i>
                          </div>
                        </div>
                        <div class="col col-stats ms-3 ms-sm-0">
                          <div class="numbers">
                            <h4 class="card-category">View Your CarePoint History</h4>
                          </div>
                        </div>
                      </div>
                    </a>
                    </div>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="d-flex align-items-left align-items-md-center flex-column flex-md-row pt-2 pb-4">
                  <div>
                    <h3 class="fw-bold mb-3">Fund Transaction History</h3>
                  </div>
                </div>
                <div id="transaction-table" class="mt-5">
                  {% if transactions %}
                  <div class="card">
                      <div class="card-header">
                          <div class="card-title">Transaction Details</div>
                      </div>
                      <div class="card-body">
                          <table class="table table-striped mt-3">
                              <thead>
                                  <tr>
                                      <th scope="col">#</th>
                                      <th scope="col">Date and Time</th>
                                      <th scope="col">Organization Name</th>
                                      <th scope="col">Type</th>
                                      <th scope="col">Page</th>
                                      <th scope="col">User</th>
                                      <th scope="col">Amount</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  {% for transaction in transactions %}
                                  <tr>
                                      <td>{{ loop.index }}</td>
                                      <td>{{ transaction.datetime }}</td>
                                      <td>{{ transaction.org_name }}</td>
                                      <td>{{ transaction.type }}</td>
                                      <td>{{ transaction.page }}</td>
                                      <td>{{ transaction.user }}</td>
                                      <td>{{ transaction.amount }}</td>
                                  </tr>
                                  {% endfor %}
                              </tbody>
                          </table>
                      </div>
                  </div>
                  {% else %}
                  <div class="alert alert-info" role="alert">
                      No fund transactions found.
                  </div>
                  {% endif %}
              </div>
              </div>
            </div>
          </div>
        
          <div id="cpWalletSection" style="display:none;">
            <div class="row">
              <div class="col-md-6">
                <div class="card card-info bg-info-gradient" style="min-height: 450px">

                  <div class="card-header">
                    <div class="card-head-row">
                      <div class="card-title">Leaderboard</div>
                    </div>
                  </div>

                  <div class="row">
                    <div class="col-md-1"></div>
                    <div class="col-md-10">
                      <div class="card">
                        <div class="d-flex align-items-center justify-content-between">
                          <div class="d-flex align-items-center">
                            <span class="me-3"></span>
                            <span class="stamp stamp-md bg-warning me-3">
                              <img src="static/img/3.jpg" alt="picture_2" style="width: 40px; height: auto;">
                            </span>
                            <div>
                              <h5 class="mb-1"><b><a href="#"> user1</a></b></h5>
                              <small class="text-muted">Tier: Platinum <small>Level</small></small>
                            </div>
                          </div>
                          <div class="ms-auto me-3">
                            <h5 class="mb-1"><b><a href="#">1000+<small> CP</small></a></b></h5>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-1"></div>
                  </div>
                  
                  <div class="row">
                    <div class="col-md-1"></div>
                    <div class="col-md-10">
                      <div class="card">
                        <div class="d-flex align-items-center justify-content-between">
                          <div class="d-flex align-items-center">
                            <span class="me-3"></span>
                            <span class="stamp stamp-md bg-warning me-3">
                              <img src="static/img/1.jpg" alt="picture_2" style="width: 40px; height: auto;">
                            </span>
                            <div>
                              <h5 class="mb-1"><b><a href="#">Johnson</a></b></h5>
                              <small class="text-muted">Tier: Gold <small>Level</small></small>
                            </div>
                          </div>
                          <div class="ms-auto me-3">
                            <h5 class="mb-1"><b><a href="#">800<small> CP</small></a></b></h5>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-1"></div>
                  </div>

                  <div class="row">
                    <div class="col-md-1"></div>
                    <div class="col-md-10">
                      <div class="card">
                        <div class="d-flex align-items-center justify-content-between">
                          <div class="d-flex align-items-center">
                            <span class="me-3"></span>
                            <span class="stamp stamp-md bg-warning me-3">
                              <img src="static/img/2.jpg" alt="picture_2" style="width: 40px; height: auto;">
                            </span>
                            <div>
                              <h5 class="mb-1"><b><a href="#">Charles John</a></b></h5>
                              <small class="text-muted">Tier: Silver <small>Level</small></small>
                            </div>
                          </div>
                          <div class="ms-auto me-3">
                            <h5 class="mb-1"><b><a href="#">350<small> CP</small></a></b></h5>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-1"></div>
                  </div>

                  <div class="row">
                    <div class="col-md-1"></div>
                    <div class="col-md-10">
                      <div class="card">
                        <div class="d-flex align-items-center justify-content-between">
                          <div class="d-flex align-items-center">
                            <span class="me-3"></span>
                            <span class="stamp stamp-md bg-warning me-3">
                              <img src="static/img/4.jpg" alt="picture_2" style="width: 40px; height: auto;">
                            </span>
                            <div>
                              <h5 class="mb-1"><b><a href="#">Scarlett Angela</a></b></h5>
                              <small class="text-muted">Tier: Silvel <small>Level</small></small>
                            </div>
                          </div>
                          <div class="ms-auto me-3">
                            <h5 class="mb-1"><b><a href="#">344<small> CP</small></a></b></h5>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-1"></div>
                  </div>

                  <div class="row">
                    <div class="col-md-1"></div>
                    <div class="col-md-10">
                      <div class="card">
                        <div class="d-flex align-items-center justify-content-between">
                          <div class="d-flex align-items-center">
                            <span class="me-3"></span>
                            <span class="stamp stamp-md bg-warning me-3">
                              <img src="static/img/5.jpg" alt="picture_2" style="width: 40px; height: auto;">
                            </span>
                            <div>
                              <h5 class="mb-1"><b><a href="#">Rosey</a></b></h5>
                              <small class="text-muted">Tier: Bronze <small>Level</small></small>
                            </div>
                          </div>
                          <div class="ms-auto me-3">
                            <h5 class="mb-1"><b><a href="#">100<small> CP</small></a></b></h5>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-1"></div>
                  </div>
                  
                  
                


                </div>
              </div>
              <div class="col-md-4">
                <div class="card card-info card-round">
                  <div class="card-header">
                    <div class="card-head-row">
                      <div class="card-title">CarePoint Wallet</div>
                    </div>
                  </div>
                  <div class="card-body pb-0" style="min-height: 400px">
                    <div class="mb-4 mt-2">
                      <br><br>
                      <h1 id="tokenBalance">Loading...</h1>
                      <br><br><br><br><br><br><br><br><br>
                      <a href="/redemption" class="btn btn-primary btn-round">
                        Purchase
                      </a>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-2">
                <div class="card card-stats card-round">
                  <div class="card-body">
                  <a href="">
                    <div class="row align-items-center">
                      <div class="col-icon">
                        <div
                          class="icon-big text-center icon-secondary bubble-shadow-small"
                        >
                          <i class="fas fa-money-check"></i>
                        </div>
                      </div>
                      <div class="col col-stats ms-3 ms-sm-0">
                        <div class="numbers">
                          
                          <h4 class="card-category">Top Up for more charity</h4>
                        </div>
                      </div>
                    </div>
                  </div>
                </a>
                </div>
                
                <div class="card card-stats card-round">
                  <div class="card-body">
                    <a href=""> <!--Add link here-->
                    <div class="row align-items-center">
                      <div class="col-icon">
                        <div
                          class="icon-big text-center icon-info bubble-shadow-small"
                        >
                          <i class="fas fa-history"></i>
                        </div>
                      </div>
                      <div class="col col-stats ms-3 ms-sm-0">
                        <div class="numbers">
                          
                          <h4 class="card-category">View your Fund History here</h4>
                        </div>
                      </div>
                    </div>
                  </a>
                  </div>
                </div>

                <div>
                  <div class="card card-stats card-round">
                    <div class="card-body">
                    <a href=""> <!--Add link here-->
                      <div class="row align-items-center">
                        <div class="col-icon">
                          <div
                            class="icon-big text-center icon-secondary bubble-shadow-small"
                          >
                            <i class="fas fa-star"></i>
                          </div>
                        </div>
                        <div class="col col-stats ms-3 ms-sm-0">
                          <div class="numbers">
                            
                            <h4 class="card-category">Use your Care Point Here</h4>
                          </div>
                        </div>
                      </div>
                    </a>
                    </div>
                  </div>
                </div>
                <div>
                  <div class="card card-stats card-round">
                    <div class="card-body">
                      <a href=""><!--Add link here-->
                      <div class="row align-items-center">
                        <div class="col-icon">
                          <div
                            class="icon-big text-center icon-info bubble-shadow-small"
                          >
                            <i class="far fa-clock"></i>
                          </div>
                        </div>
                        <div class="col col-stats ms-3 ms-sm-0">
                          <div class="numbers">
                            <h4 class="card-category">View Your CarePoint History</h4>
                          </div>
                        </div>
                      </div>
                    </a>
                    </div>
                  </div>
                </div>

              </div>
              <div class="row">
                <div class="d-flex align-items-left align-items-md-center flex-column flex-md-row pt-2 pb-4">
                  <div>
                    <h3 class="fw-bold mb-3">CarePoint Transaction History</h3>
                  </div>
                </div>
                <div id="transaction-table" class="mt-5">
                  {% if cp_transactions %}
                  <div class="card">
                      <div class="card-header">
                          <div class="card-title">Transaction Details</div>
                      </div>
                      <div class="card-body">
                          <table class="table table-striped mt-3">
                              <thead>
                                  <tr>
                                      <th scope="col">#</th>
                                      <th scope="col">Date and Time</th>
                                      <th scope="col">Organization Name</th>
                                      <th scope="col">Type</th>
                                      <th scope="col">Page</th>
                                      <th scope="col">User</th>
                                      <th scope="col">Amount</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  {% for cp_transaction in cp_transactions %}
                                  <tr>
                                      <td>{{ loop.index }}</td>
                                      <td>{{ cp_transaction.datetime }}</td>
                                      <td>{{ cp_transaction.product }}</td>
                                      <td>{{ cp_transaction.type }}</td>
                                      <td>{{ cp_transaction.page }}</td>
                                      <td>{{ cp_transaction.user }}</td>
                                      <td>{{ cp_transaction.amount }}</td>
                                  </tr>
                                  {% endfor %}
                              </tbody>
                          </table>
                      </div>
                  </div>
                  {% else %}
                  <div class="alert alert-info" role="alert">
                      No fund transactions found.
                  </div>
                  {% endif %}
              </div>
              </div>

            </div>
          </div>
        </div>

        

      </div>

      </div>
    </div>


  </div>

</div>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    // Fetch balance from the Flask API
    fetchBalance();

    const fundWalletRadio = document.getElementById('fundWallet');
    const cpWalletRadio = document.getElementById('cpWallet');
    const fundWalletSection = document.getElementById('fundWalletSection');
    const cpWalletSection = document.getElementById('cpWalletSection');

    // Function to toggle the wallet sections
    function toggleWalletSections() {
        if (fundWalletRadio.checked) {
            fundWalletSection.style.display = 'block';
            cpWalletSection.style.display = 'none';
        } else if (cpWalletRadio.checked) {
            fundWalletSection.style.display = 'none';
            cpWalletSection.style.display = 'block';
        }
    }

    // Attach event listeners to radio buttons
    fundWalletRadio.addEventListener('change', toggleWalletSections);
    cpWalletRadio.addEventListener('change', toggleWalletSections);

    // Initial call to set the correct visibility on page load
    toggleWalletSections();

    // Add event listener for Top Up button
    document.getElementById('topUpButton').addEventListener('click', topUp);
});

async function fetchBalance() {
    try {
        const userId = "{{username}}"; // Use the actual user ID from your application context

        const response = await fetch('/api/check-balance', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ userId: userId })
        });

        const data = await response.json();

        if (data.balance_from_api !== undefined) {
            document.getElementById('balance').innerText = `RM ${data.balance_in_db.toFixed(2)}`;
            document.getElementById('tokenBalance').innerText = `${data.balance_from_api.toFixed(2)} CP`;
        } else {
            document.getElementById('balance').innerText = "Error fetching balance";
        }
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('balance').innerText = "Error fetching balance";
    }
}

async function topUp() {
    try {
        const { value } = await Swal.fire({
            title: 'Input Top Up Amount',
            input: 'text',
            inputAttributes: {
                'placeholder': 'Enter amount',
                'type': 'number',
                'class': 'form-control'
            },
            showCancelButton: true,
            confirmButtonText: 'Top Up',
            cancelButtonText: 'Cancel',
            inputValidator: (value) => {
                if (!value || isNaN(value) || parseFloat(value) <= 0) {
                    return 'Please enter a valid amount';
                }
            }
        });

        if (value) {
            const amount = parseFloat(value);
            const userId = "{{username}}"; // Use the actual user ID from your application context
            const transactionUrl = '/api/transaction'; // Ensure this is the correct endpoint

            // Fetch for top up
            const response = await fetch('/api/top-up', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ userId: userId, amount: amount })
            });

            const data = await response.json();

            if (response.ok) {
                if (data.new_balance !== undefined) {
                    document.getElementById('balance').innerText = `RM ${data.new_balance.toFixed(2)}`;
                    Swal.fire('Success', 'Top up successful!', 'success');

                    // Fetch for transaction logging
                    await fetch(transactionUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            orgName: "Top Up",
                            amount: amount,
                            type: 'Fund',
                            user: userId,
                            page: 'Top up'
                        })
                    });

                } else {
                    Swal.fire('Error', data.message || 'Top up failed', 'error');
                }
            } else {
                Swal.fire('Error', data.message || 'Top up failed', 'error');
            }
        }
    } catch (error) {
        console.error('Error:', error);
        Swal.fire('Error', 'Top up failed', 'error');
    }
}

  

  </script>
{% endblock %}